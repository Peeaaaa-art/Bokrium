name: RSpec

on:
  workflow_call:

permissions:
  contents: read

jobs:
  rspec_fast:
    name: "test - RSpec fast (${{ matrix.node_index }}/4)"
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        node_index: [1, 2, 3, 4] # ← fast側の並列数

    env:
      RAILS_ENV: test
      APP_HOST: http://localhost:3000
      PORT: "3000"
      LINE_CHANNEL_TOKEN: dummy_token_for_test
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
      TOTAL_NODES: 4
      NODE_INDEX: ${{ matrix.node_index }}

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rspec-env

      - name: Run RSpec FAST (exclude spec/system)
        env:
          GUEST_USER_EMAIL: ${{ secrets.GUEST_USER_EMAIL || 'guest@example.com' }}
        run: bin/run-rspec-matrix --glob "spec/**/*_spec.rb" --exclude "spec/system/"

  rspec_system:
    name: "test - RSpec system (${{ matrix.node_index }}/2)"
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        node_index: [1, 2] # ← system側はまず2で十分（重いので）

    env:
      RAILS_ENV: test
      APP_HOST: http://localhost:3000
      PORT: "3000"
      LINE_CHANNEL_TOKEN: dummy_token_for_test
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
      TOTAL_NODES: 2
      NODE_INDEX: ${{ matrix.node_index }}

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-rspec-env

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run RSpec SYSTEM (spec/system only)
        env:
          # フォークPRなどで secret が未設定でも spec が通るようデフォルトを設定
          GUEST_USER_EMAIL: ${{ secrets.GUEST_USER_EMAIL || 'guest@example.com' }}
        run: bin/run-rspec-matrix --glob "spec/system/**/*_spec.rb"

      - name: Collect failed screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-node-${{ matrix.node_index }}
          path: tmp/screenshots
          if-no-files-found: ignore

  rspec_all:
    name: "test - RSpec gate"
    runs-on: ubuntu-24.04
    needs: [rspec_fast, rspec_system]
    if: always()
    steps:
      - name: Ensure all RSpec jobs passed
        run: |
          if [ "${{ needs.rspec_fast.result }}" != "success" ] || \
             [ "${{ needs.rspec_system.result }}" != "success" ]; then
            echo "Some RSpec jobs failed"
            exit 1
          fi
          echo "All RSpec jobs passed"
