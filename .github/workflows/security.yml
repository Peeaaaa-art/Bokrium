# Security: スキャン系を 1 本に集約
# Hadolint, OSV-Scanner, Semgrep, Trivy, Scorecard
# 結果は Security > Code scanning に表示される
#
# This workflow uses actions that are not certified by GitHub.

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:
    branches: [main]
  schedule:
    - cron: "30 1 15 * *"  # 毎月15日 01:30 UTC (Trivy)
    - cron: "0 2 15 * *"   # 毎月15日 02:00 UTC (OSV)
    - cron: "0 3 15 * *"   # 毎月15日 03:00 UTC (Semgrep)
    - cron: "0 4 15 * *"   # 毎月15日 04:00 UTC (Scorecard)
    - cron: "0 5 15 * *"   # 毎月15日 05:00 UTC (Hadolint)
  workflow_dispatch: {}
  branch_protection_rule:

permissions:
  contents: read

jobs:
  hadolint:
    name: "security - Hadolint"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run hadolint
        uses: hadolint/hadolint-action@f988afea3da57ee48710a9795b6bb677cc901183
        with:
          dockerfile: ./Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89
        with:
          sarif_file: hadolint-results.sarif
          wait-for-processing: true

  osv-scheduled:
    name: "security - OSV-Scanner (push/schedule)"
    if: ${{ github.event_name == 'push' || github.event_name == 'schedule' }}
    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable.yml@v2.3.2
    with:
      scan-args: |-
        -r
        --skip-git
        ./
    permissions:
      contents: read
      security-events: write

  osv-pr:
    name: "security - OSV-Scanner (PR)"
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'merge_group' }}
    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable-pr.yml@v2.3.2
    with:
      scan-args: |-
        -r
        --skip-git
        ./
    permissions:
      contents: read
      security-events: write

  semgrep:
    name: "security - Semgrep"
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@fcd5ab7459e8d91cb1777481980d1b18b4fc6735
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          generateSarif: "1"

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
        if: always()

  trivy:
    name: "security - Trivy"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build image from Dockerfile
        run: docker build -t bokrium:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
        with:
          image-ref: "bokrium:${{ github.sha }}"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89
        with:
          sarif_file: "trivy-results.sarif"

  scorecard:
    name: "security - Scorecard"
    runs-on: ubuntu-latest
    if: github.event.repository.default_branch == github.ref_name || github.event_name == 'pull_request'
    permissions:
      security-events: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          persist-credentials: false

      - name: Run analysis
        uses: ossf/scorecard-action@f49aabe0b5af0936a0987cfb85d86b75731b0186
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload artifact
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1
        with:
          name: SARIF file
          path: results.sarif
          retention-days: 5

      - name: Upload to code-scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
