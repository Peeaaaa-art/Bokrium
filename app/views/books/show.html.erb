<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <!-- Ë°®Á¥ô„ÉªÊÉÖÂ†±„Éª„Çø„Ç∞„Ç´„É©„É† -->
      <div class="row mb-4">
        <!-- Ë°®Á¥ô„Ç´„É©„É† -->
        <div class="col-6 col-md-3 mb-3 mb-md-0">
          <div class="card h-100 border-0 shadow-none bg-transparent">
            <div class="card-body text-center d-flex align-items-center justify-content-center">
              <div class="book-cover">
                <% if @book.book_cover_s3.attached? %>
                  <%= image_tag @book.book_cover_s3, alt: @book.title, class: "img-fluid rounded" %>
                <% elsif @book.book_cover.present? %>
                  <img src="<%= @book.book_cover %>" alt="Ë°®Á¥ôÁîªÂÉè" class="img-fluid rounded" >
                <% else %>
                  <div class="no-cover p-4 bg-light rounded"><%= @book.title %></div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- ÊÉÖÂ†±„Ç´„É©„É† -->
        <div class="col-6 col-md-5 mb-3 mb-md-0">
          <div class="card h-100 border-0 shadow-none bg-transparent">
            <div class="card-body">
              <h3 class="fw-semibold fs-4 mb-2"><%= @book.title %></h3>
              <div class="mb-2 text-secondary fs-6"><%= @book.author.presence || "ËëóËÄÖÔºü" %></div>
              <div class="mb-2">
                <span class="text-secondary me-3">
                  <i class="bi bi-building"></i> <%= @book.publisher.presence || "Âá∫ÁâàÁ§æÔºü" %>
                </span>
              </div>
              <div class="mt-3">
                <% if @book.page.present? %>
                  <span class="text-secondary me-3">
                    <i class="bi bi-file-earmark-text"></i> <%= "#{@book.page}„Éö„Éº„Ç∏" %>
                  </span>
                <% end %>
                <% if @book.price.present? %>
                  <span class="text-secondary">
                    <i class="bi bi-currency-yen"></i> <%= @book.price %>
                  </span>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- „Çø„Ç∞„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥„Ç´„É©„É† -->
        <div class="col-12 col-md-4">
          <div class="card h-100 border-0 shadow-none bg-transparent">
            <div class="card-body">
              <h5 class="card-title"><i class="bi bi-tags"></i> Tags</h5>
              <!-- „Çø„Ç∞Ë°®Á§∫ -->
              <div class="mb-2 tag-container">
                <% @book.tag_list.each do |tag| %>
                  <span class="badge rounded-pill bg-primary text-light me-1" style="font-size: 0.9em;">
                    <%= tag %>
                  </span>
                <% end %>
              </div>
        
              <!-- „Çø„Ç∞Á∑®ÈõÜ„Éú„Çø„É≥ -->
              <button class="btn btn-sm btn-outline-info mb-2" data-bs-toggle="collapse" data-bs-target="#tagForm" aria-expanded="false" aria-controls="tagForm">
                <i class="bi bi-pencil-square"></i> „Çø„Ç∞„ÇíÁ∑®ÈõÜ
              </button>

              <!-- „Çø„Ç∞ËøΩÂä†„Éï„Ç©„Éº„É† -->
              <div class="collapse" id="tagForm">
                <%= form_with model: @book, local: true, html: { class: "w-100 mt-2" } do |f| %>
                  <div class="input-group mb-2">
                    <%= text_field_tag :tags, @book.tag_list.join(" "), class: "form-control", placeholder: "Â∞èË™¨ Âì≤Â≠¶ „Éü„Çπ„ÉÜ„É™„Éº" %>
                    <%= f.submit "‰øùÂ≠ò", class: "btn btn-success" %>
                  </div>
                <% end %>
                <small class="form-text text-muted">„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÅßÂÖ•ÂäõÔºà‰æã: Â∞èË™¨ Âì≤Â≠¶Ôºâ</small>
              </div>

              <!-- „Çø„Ç∞Êú™ÈÅ∏Êäû„Éú„Çø„É≥ -->
              <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#tagSelectModal">
                „Çø„Ç∞„ÇíÈÅ∏Êäû
              </button>

              <!-- „Çø„Ç∞ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
              <div class="modal fade" id="tagSelectModal" tabindex="-1" aria-labelledby="tagSelectModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="tagSelectModalLabel">„Çø„Ç∞„ÇíÈÅ∏Êäû</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Èñâ„Åò„Çã"></button>
                    </div>
                    <div class="modal-body">
                      <div class="d-flex flex-wrap gap-2">
                        <% @user_tags.each do |tag| %>
                          <%= button_to assign_tag_book_path(@book, tag_name: tag.name),
                                        method: :post,
                                        class: "btn btn-sm text-white",
                                        style: "background-color: #{tag.color.presence || '#6c757d'};" do %>
                            <%= tag.name %>
                          <% end %>
                        <% end %>
                      </div>
                      <hr>
                      <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#tagCreateModal">
                        Ôºã Êñ∞„Åó„ÅÑ„Çø„Ç∞„Çí‰ΩúÊàê
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- „Çø„Ç∞‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
              <div class="modal fade" id="tagCreateModal" tabindex="-1" aria-labelledby="tagCreateModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="tagCreateModalLabel">Êñ∞„Åó„ÅÑ„Çø„Ç∞„Çí‰ΩúÊàê</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Èñâ„Åò„Çã"></button>
                    </div>
                    <div class="modal-body">
                      <%= form_with url: tags_path, method: :post, local: true do |f| %>
                        <div class="mb-3">
                          <%= f.label :name, "„Çø„Ç∞Âêç", class: "form-label" %>
                          <%= f.text_field :name, class: "form-control", name: "tag[name]", placeholder: "‰æã: Âì≤Â≠¶„ÄÅÂ∞èË™¨„Å™„Å©" %>
                        </div>
                        <div class="mb-3">
                          <%= f.label :color, "„Çø„Ç∞„ÅÆËâ≤", class: "form-label" %>
                          <%= f.color_field :color, class: "form-control form-control-color", name: "tag[color]", value: "#6c757d" %>
                        </div>
                        <div class="text-end">
                          <%= f.submit "‰ΩúÊàê", class: "btn btn-primary" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Êõ∏Á±ç„Å´Á¥ê„Å•„Åè„Çø„Ç∞Ë°®Á§∫ -->
              <div class="d-flex flex-wrap gap-2 mt-2">
                <% @book.tags&.each do |tag| %>
                  <span class="badge rounded-pill" style="background-color: <%= tag.color.presence || '#6c757d' %>;">
                    <%= tag.name %>
                  </span>
                <% end %>
              </div>


              <!-- ‚úÖ PCÂ∞ÇÁî®Ôºö„Çπ„ÉÜ„Éº„Çø„Çπ + „Ç¢„ÇØ„Ç∑„Éß„É≥ + ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
              <div class="d-none d-sm-flex flex-column gap-2 mt-3">
                <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Çª„É¨„ÇØ„Éà -->
                <%= form_with(model: @book, local: false, class: "status-form") do |f| %>
                  <div class="d-flex align-items-center mb-2">
                    <%= f.select :status,
                          Book.statuses.keys.map { |s| [t("books.status.#{s}"), s] },
                          {},
                          class: "form-select form-select-sm",
                          style: "width: auto; min-width: 120px;",
                          onchange: "this.form.requestSubmit();" %>
                  </div>
                <% end %>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div class="d-flex gap-2">
                  <%= link_to edit_book_path(@book), class: "btn btn-warning btn-sm" do %>
                    <i class="bi bi-pencil-square"></i> Á∑®ÈõÜ
                  <% end %>
                  <%= link_to book_path(@book),
                    data: { turbo_method: :delete, turbo_confirm: "Êú¨„ÅÆ„Éá„Éº„Çø„Å®„É°„É¢„ÅåÂâäÈô§„Åï„Çå„Çã„Å®„ÄÅ„ÇÇ„Å®„Å´Êàª„Åô„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÅãÔºü" },
                    class: "btn btn-danger btn-sm" do %>
                    <i class="bi bi-trash2"></i> ÂâäÈô§
                  <% end %>
                </div>

                <!-- ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
                <div data-controller="image-upload" class="mt-2">
                  <%= form_with model: [@book, Image.new], local: false,
                        html: {
                          multipart: true,
                          class: "d-inline-flex align-items-center",
                          data: { image_upload_target: "form" }
                        } do |f| %>
                    <%= f.file_field :image_path,
                          direct_upload: true,
                          class: "d-none",
                          data: {
                            image_upload_target: "fileInput",
                            action: "change->image-upload#triggerUpload"
                          },
                          id: "customFileInput" %>
                    <label for="customFileInput" class="btn btn-outline-secondary btn-sm mb-0">
                      <i class="bi bi-camera-fill"></i> ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    </label>
                  <% end %>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ „Çπ„Éû„ÉõÂ∞ÇÁî®Ôºö„Çπ„ÉÜ„Éº„Çø„Çπ + „Ç¢„ÇØ„Ç∑„Éß„É≥ + „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ Ê®™‰∏¶„Å≥ -->
      <div class="d-flex d-sm-none flex-row align-items-center justify-content-between px-3">
        <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Çª„É¨„ÇØ„Éà -->
        <%= form_with(model: @book, local: false, class: "status-form mb-0") do |f| %>
          <%= f.select :status,
                Book.statuses.keys.map { |s| [t("books.status.#{s}"), s] },
                {},
                class: "btn btn-outline-secondary px-4 text-start",
                style: "min-width: 90px; height: calc(1.5em + .5rem + 2px);",
                onchange: "this.form.requestSubmit();" %>
        <% end %>

        <!-- ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
        <div data-controller="image-upload">
          <%= form_with model: [@book, Image.new], local: false,
                html: {
                  multipart: true,
                  class: "d-inline",
                  data: { image_upload_target: "form" }
                } do |f| %>
            <%= f.file_field :image_path,
                  direct_upload: true,
                  class: "d-none",
                  data: {
                    image_upload_target: "fileInput",
                    action: "change->image-upload#triggerUpload"
                  },
                  id: "customFileInputSm" %>
            <label for="customFileInputSm" class="btn btn-outline-secondary btn-sm px-4 mb-0">
              <i class="bi bi-camera-fill"></i>
            </label>
          <% end %>
        </div>

        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥Ôºö„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm px-4 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-dot"></i><i class="bi bi-dot"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <%= link_to edit_book_path(@book), class: "dropdown-item" do %>
                <i class="bi bi-pencil-square"></i> Á∑®ÈõÜ
              <% end %>
            </li>
            <li>
              <%= link_to book_path(@book),
                data: { turbo_method: :delete, turbo_confirm: "Êú¨„ÅÆ„Éá„Éº„Çø„Å®„É°„É¢„ÅåÂâäÈô§„Åï„Çå„Çã„Å®„ÄÅ„ÇÇ„Å®„Å´Êàª„Åô„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÅãÔºü" },
                class: "dropdown-item text-danger" do %>
                <i class="bi bi-trash2"></i> ÂâäÈô§
              <% end %>
            </li>
          </ul>
        </div>
      </div>

      <!-- ÁîªÂÉè„É™„Çπ„Éà -->
      <div class="row row-cols-4 row-cols-md-6 g-2 mb-4 mt-2" id="image-list">
        <% @book.images.each_with_index do |img, idx| %>
          <div class="col">
            <%= render partial: "images/card", locals: { image: img, book: @book, thumb: true, identifier: idx } %>
          </div>
        <% end %>
      </div>

      <!-- „É°„É¢Ë°®Á§∫ -->
      <% if @memos.present? %>
        <% @memos.first&.tap do |memo| %>
          <%= render "memos/read_only_item", book: @book, memo: memo %>
        <% end %>
      
        <%= render partial: "memos/read_only_item", collection: @memos.drop(1), as: :memo, locals: { book: @book } %>
      <% else %>
        <!-- Êñ∞Ë¶è„É°„É¢„ÅÆ read_only Ë°®Á§∫Ôºà„Åæ„Å†‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÁä∂ÊÖãÔºâ -->
        <%= render "memos/read_only_item", book: @book, memo: @new_memo %>
      <% end %>
      
      <!-- „É¢„Éº„ÉÄ„É´„ÅØ1„Å§„Å†„Åë -->
      <%= render "memos/modal_shared", memo: @new_memo %>
      
      <!-- üìå ÂÖ±ÈÄö„ÅÆ„É¢„Éº„ÉÄ„É´„ÅØ1ÂÄã„Å†„Åë -->
      <%= render "memos/modal_shared", memo: @new_memo %>

      <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
      <div class="d-flex justify-content-center gap-3 mt-4 mb-3">
        <!-- Êñ∞Ë¶è„É°„É¢‰ΩúÊàê„Éú„Çø„É≥ -->
        <%= button_tag type: "button", class: "btn btn-outline-primary", data: {
          controller: "memo-modal",
          action: "click->memo-modal#open",
          memo_modal_memo_id_value: "new",
          memo_modal_book_id_value: @book.id
        } do %>
          <i class="bi bi-pen"></i> „ÇÇ„Å£„Å®Êõ∏„Åè
        <% end %>
        <%= link_to "Êàª„Çã", books_path, class: "btn btn-secondary" %>
      </div>

    </div>
  </div>
</div>