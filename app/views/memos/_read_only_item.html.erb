<div
  id="<%= dom_id(memo) %>"
  class="card memo-display position-relative mb-3 shadow-sm rounded"
  data-controller="memo-modal"
  data-action="click->memo-modal#open"
  data-memo-modal-memo-id-value="<%= memo.id || 'new' %>"
  data-memo-modal-book-id-value="<%= book.id %>"
  data-memo-modal-initial-content-value="<%= memo.content || "" %>"
  data-memo-modal-created-at-value="<%= memo.created_at&.strftime('%F %R') %>"
  data-memo-modal-updated-at-value="<%= memo.updated_at&.strftime('%F %R') %>"
  data-memo-modal-created-date-value="<%= memo.created_at&.strftime('%F') %>"
  data-memo-modal-updated-date-value="<%= memo.updated_at&.strftime('%F') %>"
  style="overflow: visible; z-index: 1;"
>


  <!-- ドロップダウン（右上） -->
  <% unless memo.new_record? %>
    <!-- 拡大・縮小 -->
    <button
      class="btn btn-sm bg-trasperant position-absolute top-0 start-0 m-2"
      data-action="click->memo-modal#toggle click->memo-modal#stop"
      aria-label="表示切り替え"
    >
      <%= bi_icon("arrows-angle-expand", css: "is-7 bi-icon-hover", data: { memo_modal_target: "icon" }) %>
    </button>
    <!-- トグルボタン -->
    <div class="dropdown position-absolute top-0 end-0 m-2" data-action="click->memo-modal#stop">
      <button class="btn btn-sm bg-transperent" data-bs-toggle="dropdown" aria-expanded="false">
        <%= bi_icon("three-dots", css: "is-7 bi-icon-hover") %>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <!-- 公開/非公開トグル -->
        <li>
          <%= form_with model: [book, memo], method: :patch do |f| %>
            <%= f.hidden_field :content, value: memo.content %>
            <div class="dropdown-item">
              <%= f.label :visibility, "公開範囲", class: "form-label small text-muted mb-1" %>
              <%= f.select :visibility,
                    [["非公開", "only_me"], ["リンク限定", "link_only"], ["公開", "public_site"]],
                    { selected: memo.visibility },
                    class: "form-select form-select-sm",
                    onchange: "this.form.requestSubmit();" %>
            </div>
          <% end %>
        </li>

        <!-- 公開リンクのコピー（link_only or public_site の場合） -->
        <% if memo.shared? && memo.public_token.present? %>
          <li>
            <button
              class="dropdown-item"
              onclick="navigator.clipboard.writeText('<%= memo.public_url %>'); alert('共有URLをコピーしました');"
            >
            <%= bi_icon("clipboard", css: "is-6 me-1") %> 共有URLをコピー
            </button>
          </li>
        <% end %>

        <!-- 削除 -->
        <li>
          <%= button_to book_memo_path(book, memo),
                        method: :delete,
                        data: {
                          turbo: true,
                          turbo_confirm: "このメモを削除しますか？"
                        },
                        form: { data: { turbo_stream: true } },
                        class: "dropdown-item text-danger" do %>
            <%= bi_icon("trash", css: "is-6 me-1") %> メモを削除する
          <% end %>
        </li>
      </ul>
    </div>
  <% end %>

  <!-- ヘッダー -->
  <div class="card-header bg-rhodia-orange d-flex justify-content-center py-2-5">
    <%= bi_icon("cloud-fog2-fill", css: "is-6") %>
    <%= bi_icon("cloud-haze2", css: "is-6") %>
    <%= bi_icon("cloud-fog2-fill", css: "is-6") %>
  </div>

<!-- 本文 -->
<div class="memo-body" data-memo-modal-target="body">
  <div class="tiptap-body rhodia-grid-bg">
    <% if @read_only && memo.content.blank? %>
      <%= memo_placeholder_html %>
    <% else %>
      <!-- 表示専用エディタ -->
      <div class="readonly-editor-root" id="readonly-editor-<%= memo.id %>"></div>

      <!-- JSONで安全にデータを渡す -->
      <script type="application/json" id="readonly-editor-data-<%= memo.id %>">
        <%= raw({ content: memo.content.to_s }.to_json) %>
      </script>
    <% end %>
  </div>
</div>

  <!-- ステータスアイコン -->
  <% if current_user == memo.user && memo.like_memos.present? %>
    <span class="small d-inline-flex align-items-center ms-2">
      <%= bi_icon("heart-fill", css: "is-6 text-danger me-1") %>
      <span class="text-muted opacity-75"><%= memo.like_memos.count %></span>
    </span>
  <% end %>

  <% if memo.persisted? %>
    <div class="position-absolute bottom-0 end-0 m-2" style="z-index: 2;">
      <% if memo.visibility?(:public_site) %>
        <%= bi_icon("globe", css: "is-6 text-primary") %>

      <% elsif memo.visibility?(:link_only) %>
        <%= bi_icon("link-45deg", css: "is-5 text-secondary") %>

      <% else %>
        <%= bi_icon("lock-fill", css: "is-6 text-dark") %>
      <% end %>
    </div>
  <% end %>
</div>