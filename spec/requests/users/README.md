# WebAuthn / Passkey テスト

このディレクトリには、WebAuthn（Passkey）機能のテストが含まれています。

## テストファイル

- `../models/credential_spec.rb` - Credential モデルのテスト（全てパス✅）

## テストの実行

```bash
# Credentialモデルテスト
bundle exec rspec spec/models/credential_spec.rb
```

## 手動テストのフロー

WebAuthn API は実際のブラウザ環境と認証デバイス（Touch ID、Face ID など）が必要なため、以下のフローを手動でテストする必要があります：

### 1. 新規ユーザー登録からパスキー設定までのフロー

1. `/users/sign_up` にアクセス
2. メールアドレス、パスワードを入力して新規登録
3. 確認メールのリンクをクリック
4. `/users/passkey_setup` にリダイレクトされる
5. 「パスキーを設定する」ボタンをクリック
6. Touch ID/Face ID のプロンプトが表示される
7. 認証が成功すると、パスキーが登録される
8. スターターガイドにリダイレクトされる

### 2. 既存ユーザーがパスキーを追加

1. メールアドレス・パスワードでログイン
2. マイページにアクセス
3. 「パスキーを追加」ボタンをクリック
4. Touch ID/Face ID のプロンプトが表示される
5. 認証が成功すると、パスキーが登録される

### 3. パスキーでログイン

1. `/users/sign_in` にアクセス
2. 「パスキーでログイン」ボタンをクリック
3. Touch ID/Face ID のプロンプトが表示される
4. 認証が成功すると、ログインが完了する
5. マイページにリダイレクトされる

### 4. パスキーの管理

1. マイページの「パスキー管理」セクションにアクセス
2. 登録済みのパスキー一覧が表示される
3. 「削除」ボタンをクリックして、パスキーを削除できる
4. ニックネームを編集できる

## モデルテストで確認していること

- ✅ Credential モデルのバリデーション
- ✅ User との関連（has_many :credentials）
- ✅ external_id の一意性制約
- ✅ sign_count の範囲制約（0以上、整数のみ）
- ✅ display_name メソッド（ニックネーム表示）
- ✅ ユーザー削除時のカスケード削除

## 手動テストで確認すること

WebAuthn API は実際のブラウザ環境と認証デバイスが必要なため、以下を手動で確認します：

- [ ] パスキー登録時のチャレンジ生成が正しい
- [ ] パスキー登録の検証が正しく行われる
- [ ] 不正なチャレンジが拒否される
- [ ] パスキーログイン時の検証が正しい
- [ ] sign_count がリプレイ攻撃対策として更新される
- [ ] 最後のパスキーは削除できない
- [ ] 他人のパスキーは削除できない
- [ ] ログイン前はパスキー操作ができない

## 将来の改善

リクエストテストやE2Eテストを追加する場合：
- Cypress や Playwright などの E2E テストツールの使用を推奨
- `spec/support/webauthn_helper.rb` にモックヘルパーの基礎を用意済み
- Base64 エンコーディングは URLsafe（padding なし）を使用
